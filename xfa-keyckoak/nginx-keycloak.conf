# =========================
# Configuração do Nginx para Keycloak
# =========================
# Este arquivo deve ser incluído ou adicionado à configuração do nginx
# para fazer proxy reverso do Keycloak
#
# O Keycloak será acessível em: https://xfinder-archery.com.br/realms/*
# =========================

# =========================
# Upstream do Keycloak
# =========================
upstream keycloak {
    ip_hash;
    # Ajuste a porta conforme necessário (padrão do Keycloak é 8080 em HTTP)
    server localhost:8080;
    # Se o Keycloak estiver em outro servidor, use:
    # server vpsking15907.publiccloud.com.br:8080;
}

# =========================
# Configuração do servidor para Keycloak
# =========================
# Esta seção deve ser adicionada ao bloco server existente
# que já tem o SSL configurado para xfinder-archery.com.br

# Adicione estas location blocks dentro do bloco server existente:

# Location para o Keycloak Admin Console (opcional, pode ser restrito)
location /admin {
    proxy_pass http://keycloak;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # Buffer settings
    proxy_buffering off;
}

# Location para os realms do Keycloak
location /realms {
    proxy_pass http://keycloak;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # Buffer settings
    proxy_buffering off;
}

# Location para recursos estáticos do Keycloak (CSS, JS, etc)
location /resources {
    proxy_pass http://keycloak;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Cache para recursos estáticos
    proxy_cache_valid 200 1h;
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
}

# Location para health check do Keycloak (opcional)
location /health {
    proxy_pass http://keycloak;
    proxy_set_header Host $http_host;
    access_log off;
}

# Location para metrics do Keycloak (opcional, pode ser restrito)
location /metrics {
    proxy_pass http://keycloak;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # Restringir acesso apenas para IPs internos (ajuste conforme necessário)
    # allow 127.0.0.1;
    # allow 10.0.0.0/8;
    # deny all;
}
